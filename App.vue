<template>
  <div
    id="app"
    v-on:mousemove="handleMouseMove($event)"
    v-on:mousedown="handleMouseDown($event)"
    v-on:mouseup="handleMouseUp($event)"
    :style="uiVariables()"
  >
    <!-- Taskbar -->
    <div ref="taskbar" class="taskbar">
      <div class="vue" ref="vue" @click="handleVueClick()">
        <svg
          version="1.1"
          viewBox="0 0 261.76 226.69"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g transform="matrix(1.3333 0 0 -1.3333 -76.311 313.34)">
            <g transform="translate(178.06 235.01)">
              <path
                d="m0 0-22.669-39.264-22.669 39.264h-75.491l98.16-170.02 98.16 170.02z"
                fill="#41b883"
              />
            </g>
            <g transform="translate(178.06 235.01)">
              <path
                d="m0 0-22.669-39.264-22.669 39.264h-36.227l58.896-102.01 58.896 102.01z"
                fill="#34495e"
              />
            </g>
          </g>
        </svg>
      </div>
    </div>

    <!-- Windows -->
    <div class="windows">
      <div
        ref="window"
        v-for="(window, idx) in windows"
        :key="window.id"
        :v-id="window.id"
        :style="windowUiVariables(idx)"
        :class="{
          active: activeItem && activeItem.id === window.id,
          maximized: window.maximized,
          minimized: minimizedWindows.find((mwId) => mwId === window.id),
          'user-interacting':
            window.id === activeItem.id && window.userInteracting,
        }"
        class="window"
        tabindex="0"
        @keyup="handleWindowKeyUp($event, window.id)"
        @mousedown="handleWindowMouseDown(window.id)"
      >
        <div class="window-controls">
          <span class="title">{{ window.title }}</span>
          <div class="buttons">
            <span
              class="button fullscreen"
              @click="handleWindowMaximize(window.id)"
            ></span>
            <span
              class="button minimize"
              @click="handleWindowMinimize(window.id)"
            ></span>
            <span
              class="button close"
              @click="handleWindowClose(window.id)"
            ></span>
          </div>
        </div>
        <div
          class="content"
          @mouseup="handleWindowContentMouseUp(window.id)"
          @mousedown="handleWindowContentMouseDown(window.id)"
        >
          <component
            :is="window.component"
            :window-id="window.id"
            :file="getFile(window.fileId)"
            :window="window"
            :ref="'window-' + window.id"
            @on-save="handleAppOnSave"
          />
          
          <!-- initiator -->
          <span
            style="display: none;"
            v-if="true && handleWindowContentInit(window.id)"
          />
        </div>
      </div>
    </div>

    <!-- Desktop -->
    <div class="desktop">
      <div
        v-for="(item, idx) in items"
        v-bind:key="item.id"
        ref="item"
        class="desktop-item"
        :class="{
          app: item.type === 'app',
          file: item.type === 'file',
          new: item.new,
          active: activeItem && activeItem.id === item.id,
        }"
        :style="desktopItemUiVariables(idx)"
        @click="handleFileClick(item.id)"
        @dblclick="handleFileDoubleClick(item.id)"
        @mousedown="handleFileMouseDown(item.id)"
      >
        <div class="wrapper">
          <div class="icon">
            <span v-if="item.type === 'app'" v-html="getAppIcon(item)" />
            <i v-else :class="getIcon(item)" />
          </div>
          <span class="name">
            {{ getName(item) }}
          </span>
        </div>
      </div>
    </div>

    <div class="svg-icon-templates">
      <span ref="icon-story">
        <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
          <path
            d="m504.484375 328.140625c0-46.4375-30.382813-85.777344-72.351563-99.238281.128907-1.640625.210938-3.292969.210938-4.964844 0-35.414062-28.710938-64.125-64.125-64.125-7.742188 0-15.160156 1.371094-22.03125 3.886719-18.035156-31.078125-51.667969-51.980469-90.1875-51.980469-42.511719 0-79.074219 25.460938-95.28125 61.964844-7.515625-3.742188-15.984375-5.855469-24.953125-5.855469-24.296875 0-44.984375 15.445313-52.785156 37.054687-43.574219 12.476563-75.464844 52.605469-75.464844 100.1875 0 43.972657 27.234375 81.578126 65.757813 96.878907-1.054688 4.621093-1.632813 9.421875-1.632813 14.363281 0 35.414062 28.710937 64.125 64.125 64.125 15.050781 0 28.878906-5.199219 39.820313-13.878906 19.113281 23.160156 48.039062 37.925781 80.414062 37.925781 33.078125 0 62.550781-15.414063 81.640625-39.449219 10.058594 9.539063 23.636719 15.402344 38.59375 15.402344 29.980469 0 54.464844-23.511719 56.027344-53.101562 41.902343-13.5 72.222656-52.800782 72.222656-99.195313zm0 0"
            fill="#fff6df"
          />
          <path
            d="m288.0625 480.4375c-32.375 0-61.300781-14.765625-80.414062-37.925781-10.941407 8.679687-24.769532 13.878906-39.820313 13.878906-35.414063 0-64.125-28.710937-64.125-64.125 0-4.941406.578125-9.742187 1.632813-14.363281-38.519532-15.300782-65.757813-52.90625-65.757813-96.878906 0-26.851563 10.160156-51.328126 26.839844-69.804688-34.855469 16.855469-58.902344 52.539062-58.902344 93.851562 0 43.972657 27.234375 81.578126 65.757813 96.878907-1.054688 4.621093-1.632813 9.421875-1.632813 14.363281 0 35.414062 28.710937 64.125 64.125 64.125 15.050781 0 28.878906-5.199219 39.820313-13.878906 19.113281 23.160156 48.039062 37.925781 80.414062 37.925781 30.6875 0 58.265625-13.269531 77.332031-34.378906-13.691406 6.617187-29.042969 10.332031-45.269531 10.332031zm0 0"
            fill="#ffedbf"
          />
          <path
            d="m352.1875 336.15625-49.785156 99.574219c-8.789063 17.574219-26.753906 28.675781-46.402344 28.675781s-37.613281-11.101562-46.402344-28.675781l-49.785156-99.574219v-96.1875h192.375zm0 0"
            fill="#ffe49f"
          />
          <path
            d="m280.046875 456.390625c-19.648437 0-37.613281-11.101563-46.402344-28.675781l-49.785156-99.574219v-88.171875h-24.046875v96.1875l49.785156 99.574219c8.789063 17.574219 26.753906 28.675781 46.402344 28.675781 10.089844 0 19.734375-2.933594 27.921875-8.164062-1.285156.097656-2.574219.148437-3.875.148437zm0 0"
            fill="#ffdb7e"
          />
          <path
            d="m352.1875 239.96875h64.125s0 56.109375-64.125 56.109375zm0 0"
            fill="#f9c19e"
          />
          <path
            d="m159.8125 239.96875h-64.125s0 56.109375 64.125 56.109375zm0 0"
            fill="#f9c19e"
          />
          <path
            d="m439.859375 223.640625c-.160156-39.367187-32.238281-71.34375-71.640625-71.34375-6.371094 0-12.640625.832031-18.71875 2.472656-20.546875-31.335937-55.832031-50.566406-93.5-50.566406-41.660156 0-79.71875 23.234375-98.925781 59.773437-6.8125-2.433593-13.949219-3.664062-21.308594-3.664062-25.4375 0-48.453125 15.292969-58.4375 38.4375-21.421875 6.945312-40.628906 20.511719-54.390625 38.496094-15.003906 19.613281-22.9375 43.066406-22.9375 67.824218 0 22.816407 6.835938 44.765626 19.769531 63.464844 11.445313 16.554688 26.929688 29.582032 45.039063 37.953125-.453125 3.269531-.683594 6.554688-.683594 9.824219 0 39.503906 32.136719 71.640625 71.640625 71.640625 13.910156 0 27.144531-3.898437 38.664063-11.332031 21.105468 22.570312 50.453124 35.378906 81.570312 35.378906 31.703125 0 61.371094-13.183594 82.539062-36.425781 10.878907 8.027343 24.003907 12.378906 37.695313 12.378906 32.109375 0 58.878906-23.816406 63.054687-55.101563 43.699219-16.226562 72.710938-57.695312 72.710938-104.710937 0-46.828125-28.757812-88.121094-72.140625-104.5zm-9.902344 196.542969c-2.964843.957031-5.035156 3.644531-5.199219 6.757812-1.363281 25.785156-22.675781 45.980469-48.523437 45.980469-12.480469 0-24.351563-4.738281-33.421875-13.339844-3.152344-2.992187-8.351562-2.621093-11.054688.78125-18.480468 23.265625-46.089843 36.609375-75.757812 36.609375-28.964844 0-56.160156-12.828125-74.617188-35.195312-2.570312-3.117188-7.300781-3.617188-10.46875-1.105469-10.101562 8.015625-22.253906 12.253906-35.148437 12.253906-31.214844 0-56.609375-25.394531-56.609375-56.609375 0-4.230468.484375-8.496094 1.445312-12.6875.828126-3.613281-1.105468-7.292968-4.550781-8.660156-37.070312-14.722656-61.019531-50.007812-61.019531-89.894531 0-42.933594 28.792969-81.160157 70.019531-92.964844 2.320313-.664063 4.179688-2.402344 5-4.671875 6.929688-19.199219 25.300781-32.09375 45.714844-32.09375 7.578125 0 14.847656 1.703125 21.605469 5.066406 3.78125 1.882813 8.507812.171875 10.21875-3.675781 15.503906-34.929687 50.210937-57.5 88.410156-57.5 34.355469 0 66.421875 18.480469 83.6875 48.234375 1.828125 3.152344 5.65625 4.539062 9.082031 3.285156 6.214844-2.273437 12.757813-3.425781 19.449219-3.425781 31.214844 0 56.609375 25.394531 56.609375 56.609375 0 2.488281-.628906 5.175781.257813 7.570312.792968 2.152344 2.570312 3.851563 4.753906 4.550782 40.152344 12.878906 67.128906 49.882812 67.128906 92.082031 0 42.140625-26.929688 79.128906-67.011719 92.042969zm0 0"
          />
          <path
            d="m416.3125 232.453125h-95.855469c-4.148437 0-7.511719 3.367187-7.511719 7.515625s3.363282 7.515625 7.511719 7.515625h24.214844v86.898437l-48.992187 97.984376c-7.5625 15.128906-22.769532 24.523437-39.679688 24.523437s-32.117188-9.394531-39.679688-24.523437l-48.992187-97.984376v-86.898437h117.730469c4.148437 0 7.511718-3.367187 7.511718-7.515625s-3.363281-7.515625-7.511718-7.515625h-189.371094c-4.152344 0-7.515625 3.367187-7.515625 7.515625 0 .652344.101563 16.203125 9.007813 31.78125 7.710937 13.496094 23.464843 29.394531 55.117187 31.578125v32.828125c0 1.167969.273437 2.316406.792969 3.359375l49.789062 99.574219c10.125 20.25 30.480469 32.832031 53.121094 32.832031s42.996094-12.582031 53.121094-32.832031l49.789062-99.574219c.519532-1.042969.792969-2.191406.792969-3.359375v-32.824219c31.652344-2.1875 47.40625-18.082031 55.117187-31.578125 8.902344-15.582031 9.007813-31.132812 9.007813-31.785156 0-4.148438-3.363281-7.515625-7.515625-7.515625zm-312.257812 15.03125h48.242187v40.777344c-36.375-3.019531-45.796875-27.941407-48.242187-40.777344zm255.648437 40.777344v-40.777344h48.238281c-2.445312 12.851563-11.875 37.757813-48.238281 40.777344zm0 0"
          />
          <path
            d="m239.46875 304.09375c0-4.148438-3.367188-7.515625-7.515625-7.515625s-7.515625 3.367187-7.515625 7.515625c0 4.695312-3.820312 8.515625-8.515625 8.515625s-8.515625-3.820313-8.515625-8.515625c0-4.148438-3.367188-7.515625-7.515625-7.515625s-7.515625 3.367187-7.515625 7.515625c0 12.984375 10.5625 23.546875 23.546875 23.546875s23.546875-10.5625 23.546875-23.546875zm0 0"
          />
          <path
            d="m287.5625 304.09375c0-4.148438-3.363281-7.515625-7.515625-7.515625s-7.515625 3.367187-7.515625 7.515625c0 12.984375 10.5625 23.546875 23.546875 23.546875s23.546875-10.5625 23.546875-23.546875c0-4.148438-3.363281-7.515625-7.515625-7.515625s-7.515625 3.367187-7.515625 7.515625c0 4.695312-3.820312 8.515625-8.515625 8.515625s-8.515625-3.820313-8.515625-8.515625zm0 0"
          />
          <path
            d="m274.734375 386.953125-8.015625 8.015625c-2.9375 2.933594-2.9375 7.691406 0 10.625 1.464844 1.46875 3.390625 2.203125 5.3125 2.203125s3.847656-.734375 5.3125-2.203125l8.019531-8.015625c2.933594-2.933594 2.933594-7.691406 0-10.625-2.9375-2.933594-7.695312-2.933594-10.628906 0zm0 0"
          />
          <path
            d="m234.65625 405.59375c1.464844 1.46875 3.390625 2.203125 5.3125 2.203125s3.847656-.734375 5.3125-2.203125c2.9375-2.933594 2.9375-7.691406 0-10.625l-8.015625-8.015625c-2.933594-2.933594-7.691406-2.933594-10.625 0-2.9375 2.933594-2.9375 7.691406 0 10.625zm0 0"
          />
          <path
            d="m360.203125 79.15625h16.429687l-22.296874 27.867188c-3.863282 4.828124-.296876 12.210937 5.867187 12.210937h32.0625c4.152344 0 7.515625-3.367187 7.515625-7.515625 0-4.152344-3.363281-7.515625-7.515625-7.515625h-16.425781l22.292968-27.867187c3.867188-4.832032.296876-12.210938-5.867187-12.210938h-32.0625c-4.152344 0-7.515625 3.363281-7.515625 7.515625 0 4.148437 3.363281 7.515625 7.515625 7.515625zm0 0"
          />
          <path
            d="m416.3125 47.09375h16.429688l-22.296876 27.867188c-3.863281 4.828124-.296874 12.210937 5.867188 12.210937h32.0625c4.152344 0 7.515625-3.367187 7.515625-7.515625 0-4.152344-3.363281-7.515625-7.515625-7.515625h-16.425781l22.292969-27.871094c3.867187-4.828125.296874-12.207031-5.867188-12.207031h-32.0625c-4.152344 0-7.515625 3.363281-7.515625 7.515625 0 4.148437 3.363281 7.515625 7.515625 7.515625zm0 0"
          />
          <path
            d="m472.421875 15.03125h16.429687l-22.296874 27.867188c-3.863282 4.828124-.296876 12.210937 5.867187 12.210937h32.0625c4.152344 0 7.515625-3.367187 7.515625-7.515625 0-4.152344-3.363281-7.515625-7.515625-7.515625h-16.425781l22.292968-27.871094c3.867188-4.828125.296876-12.207031-5.867187-12.207031h-32.0625c-4.148437 0-7.515625 3.363281-7.515625 7.515625 0 4.148437 3.367188 7.515625 7.515625 7.515625zm0 0"
          />
        </svg>
      </span>
      <span ref="icon-brush">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
          <path style="fill:#FFE67D;" d="M512,256c0,141.385-114.615,256-256,256S0,397.385,0,256S114.615,0,256,0S512,114.615,512,256z"/>
          <path style="fill:#B9783D;" d="M389.719,205.58l-36.38,99.953l-26.971,74.103l-30.109,82.723
            c-5.49,15.085-22.17,22.863-37.255,17.372c-1.41-0.513-2.756-1.125-4.034-1.823c-1.228,0.661-2.516,1.245-3.866,1.736l0,0
            c-15.085,5.49-31.764-2.287-37.254-17.372l-93.46-256.779c-5.142-14.128,2.142-29.749,16.27-34.891l3.465-1.261
            c14.128-5.142,29.749,2.142,34.891,16.27l36.38,99.953l15.536,42.686V172.852c0-15.035,12.188-27.223,27.222-27.223h3.687
            c15.035,0,27.223,12.188,27.223,27.223v106.367v43.925l50.026-137.446c5.142-14.128,20.763-21.412,34.891-16.27l3.465,1.261
            C387.577,175.831,394.861,191.452,389.719,205.58z"/>
          <path style="fill:#965028;" d="M382.383,176.871c-10.867,0.987-20.725,8.076-24.705,19.009l-92.829,255.046
            c-2.378,6.533-2.249,13.358-0.133,19.449c1.158,0.764,2.372,1.451,3.637,2.046c-0.779,0.366-1.581,0.691-2.396,0.989
            c1.402,2.927,3.282,5.627,5.597,7.958c-4.127,0.375-8.398-0.126-12.55-1.637l0,0c-1.413-0.514-2.762-1.127-4.042-1.827
            c-1.227,0.661-2.509,1.25-3.857,1.74l0,0c-15.085,5.49-31.764-2.287-37.254-17.372l-92.829-255.046
            c-5.49-15.084,2.287-31.764,17.372-37.254l0,0c4.152-1.511,8.423-2.012,12.55-1.637c-7.69,7.741-10.685,19.509-6.706,30.442
            l82.696,227.205V174.695c0-16.053,13.013-29.066,29.066-29.066l0,0c4.418,0,8.603,0.99,12.353,2.754
            c-9.875,4.644-16.713,14.678-16.713,26.312v240.286l82.822-227.551c5.49-15.085,22.17-22.862,37.254-17.372l0,0
            C375.868,171.569,379.462,173.931,382.383,176.871z"/>
          <path style="fill:#80391B;" d="M312.25,34.317l-10.034,35.589l-15.006,45.216c-8.012-1.987-19.034-3.215-31.21-3.215
            s-23.198,1.229-31.21,3.215l-14.83-44.686l-8.592-36.119c-2.262-6.816,0.189-14.372,6.132-18.404C222.3,5.87,236.766,2.5,256,2.5
            s35.317,3.37,50.118,13.413C312.061,19.946,314.512,27.502,312.25,34.317z M419.25,47.75c0.195-0.553,0.098-1.17-0.05-1.737
            c-0.694-2.672,1.049-4.863-1.2-3.263L359.25,87c-6.268,4.46-13.507,7.332-17.191,13.639c-8.526,14.598-9.796,32.882-2.27,49.021l0,0
            c6.599,14.152,18.666,24.009,32.512,28.229c12.041,3.669,25.426,3.076,37.732-2.662l0,0c8.736-4.074,16.379-9.977,21.088-17.771
            c5.739-9.499,7.948-18.833,8.046-27.952C439.504,97.909,410.662,72.068,419.25,47.75z M91,40c-6.5,23.75-10.262,57.242-3.114,86.821
            c1.388,5.743,2.987,11.133,4.751,15.979c10.847,29.802,25.856,33.363,52.516,45.74c12.467-26.618,21.676-38.993,10.828-68.795
            c-1.797-4.937-3.892-10.298-6.78-15.592C134.25,76.75,113.75,56.5,91,40z"/>
          <path style="fill:#FF5A5F;" d="M314.027,34.317l-12.692,38.244c-4.768-0.694-8.581-4.296-9.603-8.953V39.431
            c0-6.39-5.18-11.569-11.569-11.569h-0.878c-6.39,0-11.569,5.18-11.569,11.569v2.074c-1.165,5.158-5.767,9.014-11.277,9.014h-0.878
            c-5.51,0-10.112-3.855-11.277-9.014v-2.074c0-6.39-5.18-11.569-11.569-11.569h-0.878c-6.389,0-11.569,5.18-11.569,11.569v24.18
            c-1.022,4.656-4.835,8.257-9.603,8.951l-12.692-38.244c-2.262-6.816,0.189-14.372,6.132-18.404C218.905,5.87,236.766,0,256,0
            s37.095,5.87,51.895,15.913C313.838,19.946,316.289,27.502,314.027,34.317z"/>
          <path style="fill:#6E96DC;" d="M439.049,132.533c-2.722,1.839-6.25,2.403-9.573,1.193l0,0c-4.762-1.733-7.523-6.521-6.888-11.346
            l0.789-2.167c2.004-5.507-0.835-11.597-6.342-13.601l0,0c-5.507-2.004-11.597,0.835-13.601,6.342l-10.467,28.759
            c-2.615,4.104-7.807,5.997-12.57,4.264c-4.762-1.733-7.522-6.521-6.888-11.346l10.467-28.759c2.004-5.507-0.835-11.597-6.342-13.601
            c-5.507-2.005-11.597,0.835-13.601,6.342l-3.208,8.815c-2.615,4.104-7.807,5.997-12.57,4.264c-4.202-1.529-6.843-5.438-6.972-9.651
            c3.74-6.874,9.04-13.001,15.768-17.788l59.877-43.624c2.249-1.6,5.404-0.452,6.099,2.22c0.148,0.568,0.245,1.184,0.049,1.737
            C414.213,69.679,441.127,99.763,439.049,132.533z"/>
          <path style="fill:#3CAF96;" d="M129.777,113.996l-7.345-20.18c-2.087-5.733-8.426-8.69-14.16-6.603s-8.69,8.426-6.603,14.16
            l7.345,20.18c0.698,5.047-2.164,10.069-7.145,11.882c-5.38,1.958-11.293-0.525-13.726-5.575c-7.365-29.7-9.074-69.308,1.488-91.861
            l0,0c22.588,10.487,46.739,41.927,60.188,69.413c1.383,5.433-1.551,11.135-6.931,13.093
            C137.907,120.318,132.486,118.311,129.777,113.996z"/>
          <path style="fill:#9BB9C3;" d="M376.186,302.729L359.129,490.36C327.576,504.264,292.694,512,256,512s-71.576-7.736-103.128-21.641
            l-17.057-187.631c-0.496-5.456,3.8-10.159,9.278-10.159h221.815C372.386,292.569,376.681,297.273,376.186,302.729z"/>
          <path style="fill:#87A0AF;" d="M360.374,476.656l-1.246,13.703C327.576,504.264,292.694,512,256,512s-71.576-7.736-103.128-21.641
            l-17.057-187.631c-0.496-5.456,3.8-10.159,9.278-10.159h24.934c-0.009,0.81-0.027,1.618-0.027,2.431c0,102.173,71.635,185,160,185
            C340.387,480,350.539,478.842,360.374,476.656z"/>
          <path style="fill:#FFF5AF;" d="M400.024,177.268L400.024,177.268c-0.249,0.684-0.514,1.361-0.786,2.034l0.04,0.015l-19.882,54.626
            v-0.001l-0.281,0.773l-54.626-19.882l6.749-18.542l13.415-36.856l0.04,0.015c0.224-0.691,0.456-1.379,0.705-2.063l0,0
            c1.373-3.771,14.714-2.377,29.799,3.113C390.281,165.989,401.396,173.497,400.024,177.268z M183.766,209.646l-19.882-54.626
            l-0.04,0.015c-0.224-0.691-0.457-1.379-0.705-2.063l0,0c-1.373-3.771-14.714-2.378-29.799,3.113s-26.201,12.999-24.828,16.77l0,0
            c0.249,0.684,0.514,1.36,0.786,2.034l-0.041,0.015l13.415,36.856l6.749,18.542l54.626-19.882L183.766,209.646L183.766,209.646z
            M288.602,107.134c-8.102-2.197-19.706-3.574-32.601-3.574c-12.895,0-24.499,1.377-32.602,3.574c-1.842,0.5-2.975,2.352-2.621,4.228
            l5.762,30.539l0.394,37.618v19.732h58.132v-0.821l0.394-56.529l5.762-30.539C291.576,109.486,290.444,107.633,288.602,107.134z"/>
          <path style="fill:#E6B464;" d="M382.92,190.268l-0.058,0.159c-1.299,3.57-5.147,5.477-8.796,4.42
            c-0.625-0.181-1.249-0.385-1.87-0.611l-12.054-4.387l-2.844,7.815l12.054,4.387c0.357,0.13,0.715,0.252,1.073,0.367
            c3.926,1.26,6.09,5.447,4.68,9.321l-0.058,0.158c-1.299,3.57-5.147,5.477-8.796,4.42c-0.625-0.181-1.249-0.384-1.87-0.61
            l-12.054-4.387l-4.385,12.049l-23.453-8.536l6.749-18.542l0.481-1.321l4.971-13.657l7.963-21.878l0.04,0.015
            c0.224-0.691,0.456-1.379,0.705-2.063l0,0c1.373-3.771,14.714-2.377,29.799,3.113c4.198,1.528,8.087,3.212,11.486,4.928
            c-9.615-2.257-16.841-2.227-17.832,0.495l0,0c-0.249,0.684-0.481,1.373-0.705,2.063l-0.041-0.015l-2.992,8.222l12.054,4.387
            c0.357,0.13,0.715,0.252,1.073,0.367C382.166,182.206,384.33,186.393,382.92,190.268z M166.207,195.396
            c-1.41-3.875-5.759-5.691-9.577-4.132c-0.348,0.142-0.701,0.279-1.058,0.409l-12.055,4.387l-2.844-7.815l12.054-4.387
            c0.621-0.226,1.229-0.471,1.825-0.734c3.474-1.536,5.196-5.471,3.897-9.04l-0.058-0.158c-1.41-3.875-5.759-5.691-9.576-4.132
            c-0.348,0.143-0.701,0.279-1.058,0.408l-12.054,4.387l-2.992-8.222l0.041-0.015c-0.272-0.673-0.537-1.35-0.786-2.034l0,0
            c-0.99-2.722,4.526-7.39,13.342-11.841c-3.708,0.87-7.769,2.08-11.967,3.608c-15.085,5.49-26.201,12.999-24.828,16.77
            c0.249,0.684,0.514,1.36,0.786,2.034l-0.041,0.015l7.963,21.878l2.543,6.987l2.908,7.99l6.749,18.542l23.453-8.536l-4.385-12.049
            l12.054-4.387c0.621-0.226,1.229-0.471,1.825-0.734c3.474-1.536,5.196-5.471,3.897-9.04L166.207,195.396z M265.854,149.024
            c-0.376,0.015-0.754,0.022-1.134,0.022h-12.828v-18.122c-0.104,0.004-5.32-27.112-5.32-27.112
            c-9.07,0.491-17.104,1.677-23.173,3.322c-1.842,0.5-2.975,2.352-2.621,4.228l5.762,30.539l0.394,21.679v14.533v1.406v19.732h24.958
            v-6.618v-6.204h12.828c0.661,0,1.316-0.022,1.966-0.066c3.79-0.255,6.754-3.364,6.754-7.162v-0.168c0-4.123-3.465-7.318-7.586-7.158
            c-0.376,0.015-0.754,0.022-1.134,0.022h-12.828v-8.316h12.828c0.661,0,1.316-0.022,1.966-0.066c3.79-0.255,6.754-3.364,6.754-7.162
            v-0.168C273.44,152.059,269.975,148.865,265.854,149.024z"/>
          </svg>
      </span>
      <span ref="icon-note">
        <svg
          version="1.1"
          id="Layer_1"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          x="0px"
          y="0px"
          viewBox="0 0 512 512"
          style="enable-background: new 0 0 512 512"
          xml:space="preserve"
        >
          <path
            style="fill: #ffca4f"
            d="M256.001,0C397.385,0,512,114.615,512,256.001C512,397.385,397.385,512,256.001,512
          S0,397.385,0,256.001S114.615,0,256.001,0z"
          />
          <path
            style="fill: #ff5b61"
            d="M99.889,96.961h312.223v361.924C368.903,492.183,314.769,512,256.001,512
          c-58.77,0-112.902-19.815-156.11-53.113V96.963L99.889,96.961z"
          />
          <path
            style="fill: #ffffff"
            d="M124.548,109.998H387.45v365.704C349.024,498.742,304.06,512,255.999,512
          c-48.064,0-93.025-13.258-131.451-36.294V110V109.998z"
          />
          <path
            style="fill: #15bdb1"
            d="M250.271,47.19h11.459c7.089,0,12.89,5.799,12.89,12.892v29.721h-37.24V60.082
          C237.379,52.991,243.182,47.19,250.271,47.19z M255.999,54.755L255.999,54.755c-5.689,0-10.294,4.608-10.294,10.297
          c0,5.686,4.606,10.294,10.294,10.294c5.689,0,10.294-4.608,10.294-10.294C266.293,59.363,261.687,54.755,255.999,54.755z"
          />
          <path
            style="fill: #20d0c2"
            d="M206.169,83.136h99.664c5.677,0,10.321,4.643,10.321,10.323v28.564H195.848V93.459
          C195.848,87.78,200.492,83.136,206.169,83.136z"
          />
          <g>
            <path
              style="fill: #d0d1d4"
              d="M218.622,164.041h146.446v7.876H218.622V164.041z M218.622,201.281L218.622,201.281H322.1v7.876
            H218.622V201.281z M218.622,182.661L218.622,182.661h146.446v7.876H218.622V182.661z"
            />
            <path
              style="fill: #d0d1d4"
              d="M218.622,261.388h146.446v7.876H218.622V261.388z M218.622,298.628L218.622,298.628H322.1v7.878
            H218.622V298.628z M218.622,280.01L218.622,280.01h146.446v7.876H218.622V280.01z"
            />
            <path
              style="fill: #d0d1d4"
              d="M218.622,358.732h146.446v7.876H218.622V358.732z M218.622,395.972L218.622,395.972H322.1v7.878
            H218.622V395.972z M218.622,377.352L218.622,377.352h146.446v7.878H218.622V377.352z"
            />
          </g>
          <path
            style="fill: #20d0c2"
            d="M435.117,291.389h24.924V59.006h-24.924V291.389z"
          />
          <g>
            <path
              style="fill: #0e7886"
              d="M447.592,340.89l12.446-49.501h-24.919L447.592,340.89z"
            />
            <path
              style="fill: #0e7886"
              d="M440.232,36.332h14.693c4.039,0,7.344,3.894,7.344,8.65v108.031h-29.384V44.981
            C432.885,40.223,436.191,36.332,440.232,36.332z"
            />
          </g>
          <path
            style="fill: #ffffff"
            d="M447.083,344.466h1.036l4.143-22.135h-9.291L447.083,344.466z"
          />
          <g>
            <path
              style="fill: #20d0c2"
              d="M432.896,54.974l35.908,0.278l2.26,0.015v2.644v80.466v0.822l-0.419,0.701l-3.402,5.728
            c-1.746,2.661-5.382,0.62-3.704-3.049l2.988-5.027V60.554l-33.648-0.258l0.02-5.323H432.896z"
            />
            <path
              style="fill: #20d0c2"
              d="M152.093,187.073c-0.734-0.873-0.622-2.176,0.254-2.91c0.871-0.734,2.176-0.622,2.91,0.251
            l7.322,8.709l20.016-17.546c0.86-0.752,2.167-0.666,2.921,0.196c0.752,0.86,0.666,2.167-0.196,2.919l-21.601,18.937l-0.002-0.004
            l-0.031,0.029c-0.873,0.734-2.176,0.62-2.91-0.251l-8.68-10.328L152.093,187.073z"
            />
            <path
              style="fill: #20d0c2"
              d="M168.819,157.257c8.105,0,15.438,3.285,20.75,8.595c5.309,5.311,8.597,12.647,8.597,20.75
            c0,8.101-3.287,15.438-8.597,20.75c-5.309,5.309-12.645,8.595-20.75,8.595c-8.101,0-15.438-3.285-20.748-8.595
            c-5.309-5.309-8.595-12.647-8.595-20.75c0-8.105,3.285-15.438,8.595-20.75C153.381,160.542,160.718,157.257,168.819,157.257z
             M186.808,168.614L186.808,168.614c-4.604-4.602-10.965-7.45-17.989-7.45c-7.025,0-13.383,2.849-17.987,7.45
            c-4.604,4.604-7.45,10.965-7.45,17.989c0,7.022,2.846,13.383,7.45,17.987c4.604,4.604,10.965,7.45,17.987,7.45
            c7.025,0,13.386-2.846,17.989-7.45c4.602-4.604,7.45-10.965,7.45-17.987C194.259,179.579,191.41,173.218,186.808,168.614z"
            />
            <path
              style="fill: #20d0c2"
              d="M152.093,284.419c-0.734-0.875-0.622-2.178,0.254-2.913c0.871-0.734,2.176-0.62,2.91,0.251
            l7.322,8.709l20.016-17.544c0.86-0.754,2.167-0.666,2.921,0.194c0.752,0.862,0.666,2.167-0.196,2.921l-21.601,18.935l-0.002-0.002
            l-0.031,0.026c-0.873,0.734-2.176,0.622-2.91-0.251l-8.68-10.325L152.093,284.419z"
            />
            <path
              style="fill: #20d0c2"
              d="M168.819,254.603c8.105,0,15.438,3.285,20.75,8.595c5.309,5.309,8.597,12.647,8.597,20.748
            c0,8.105-3.287,15.438-8.597,20.75c-5.309,5.309-12.645,8.595-20.75,8.595c-8.101,0-15.438-3.285-20.748-8.595
            c-5.309-5.311-8.595-12.647-8.595-20.75c0-8.101,3.285-15.438,8.595-20.748S160.718,254.603,168.819,254.603z M186.808,265.96
            L186.808,265.96c-4.604-4.604-10.965-7.45-17.989-7.45c-7.025,0-13.383,2.846-17.987,7.45c-4.604,4.604-7.45,10.965-7.45,17.987
            c0,7.025,2.846,13.386,7.45,17.989c4.604,4.602,10.965,7.45,17.987,7.45c7.025,0,13.386-2.849,17.989-7.45
            c4.602-4.604,7.45-10.965,7.45-17.989C194.259,276.925,191.41,270.564,186.808,265.96z"
            />
            <path
              style="fill: #20d0c2"
              d="M152.093,381.766c-0.734-0.875-0.622-2.176,0.254-2.913c0.871-0.734,2.176-0.622,2.91,0.251
            l7.322,8.709l20.016-17.546c0.86-0.752,2.167-0.666,2.921,0.196c0.752,0.86,0.666,2.167-0.196,2.919l-21.601,18.935l-0.002-0.002
            l-0.031,0.029c-0.873,0.734-2.176,0.62-2.91-0.254l-8.68-10.325H152.093z"
            />
            <path
              style="fill: #20d0c2"
              d="M168.819,351.948c8.105,0,15.438,3.285,20.75,8.597c5.309,5.309,8.597,12.645,8.597,20.75
            c0,8.101-3.287,15.438-8.597,20.748c-5.309,5.309-12.645,8.595-20.75,8.595c-8.101,0-15.438-3.285-20.748-8.595
            s-8.595-12.647-8.595-20.748c0-8.105,3.285-15.438,8.595-20.75S160.718,351.948,168.819,351.948z M186.808,363.305L186.808,363.305
            c-4.604-4.602-10.965-7.45-17.989-7.45c-7.025,0-13.383,2.849-17.987,7.45c-4.604,4.604-7.45,10.965-7.45,17.989
            c0,7.022,2.846,13.383,7.45,17.987c4.604,4.604,10.965,7.45,17.987,7.45c7.025,0,13.386-2.846,17.989-7.45
            c4.602-4.604,7.45-10.965,7.45-17.987C194.259,374.269,191.41,367.908,186.808,363.305z"
            />
          </g>
        </svg>
      </span>
    </div>
  </div>
</template>

<script>
import Vue from "vue/dist/vue.esm.js";

// Dump vuedit file
// #
const aNote =
  "JTdCJTIyaWQlMjIlM0ElMjJlZTJmMTllZDIyNDYlMjIlMkMlMjJmaWxlVHlwZSUyMiUzQSUyMnZ1ZWRpdCUyMiUyQyUyMmZpbGVOYW1lJTIyJTNBJTIyYSUyMG5vdGUlMjIlMkMlMjJjb250ZW50JTIyJTNBJTIyJTNDYiUzRUxldCdzJTIwbWFrZSUyMGElMjBzdGF0ZW1lbnQhJTNDJTJGYiUzRSUzQ2RpdiUzRSUzQ2klM0VCdSUyMGJpciUyMGl0YWxpayUyMG1ldGluLiUzQyUyRmklM0UlM0NiciUzRSUzQyUyRmRpdiUzRSUzQ2RpdiUzRSUzQ3UlM0UlQzMlQjZuZW1saSUyMGJpciUyMHV5YXIlQzQlQjEuJTNDJTJGdSUzRSUzQ2JyJTNFJTNDJTJGZGl2JTNFJTIyJTdE";

const parse = JSON.parse;
const stringify = JSON.stringify;

const MOUSE_STATES = {
  UP: "up",
  DOWN: "down",
};

const APP_FILE_TYPES = {
  vuedit: "vuedit",
  story: "story",
  vrush: "vrush",
};

const APP_ITEM_TYPES = {
  window: "window",
  file: "file",
  app: "app",
};

/**
 * @desc Prevent ctrl+s
 */
document.addEventListener(
  "keydown",
  function (e) {
    if (
      e.key === "s" &&
      (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)
    ) {
      e.preventDefault();
    }
  },
  false
);

/**
 * @desc Matches & Closest polyfills
 * @jonathantneal https://github.com/jonathantneal/closest/blob/master/src/index.js
 */
const ElementPrototype = window.Element.prototype;
if (typeof ElementPrototype.matches !== "function") {
  /**
   * @desc Add matches method to html element prototype
   * @param selector -
   */
  ElementPrototype.matchs =
    ElementPrototype.msMatchesSelector ||
    ElementPrototype.mozMatchesSelector ||
    ElementPrototype.webkitMatchesSelector ||
    function matches(selector) {
      let idx = 0;
      let element = this;
      const elements = (
        element.document || element.ownerDocument
      ).querySelectorAll(selector);

      while (elements[idx] && elements[idx] !== element) {
        idx++;
      }
      return Boolean(elements[idx]);
    };
}

if (typeof ElementPrototype.closest !== "function") {
  /**
   * @desc Add closest method to html element prototype
   * @param selector -
   */
  ElementPrototype.closest = function closest(selector) {
    let element = this;

    while (element && element.nodeType === Node.ELEMENT_NODE) {
      if (element.matches(selector)) {
        return element;
      }
      element = element.parentNode;
    }
    return null;
  };
}

const helpers = {
  /**
   * @Vue - data
   */
  data() {
    return {
      helpers: {
        http: {
          /**
           * @desc Makes an http get request
           * @param url -
           */
          get(url) {
            return fetch(url).then((res) => res.json());
          },
        },

        /**
         * @desc Generates random ID
         */
        randid() {
          return Math.random().toString(16).slice(2, -1);
        },
      },
    };
  },
};

const system = {
  /**
   * @Vue - computed
   */
  computed: {
    _helpers() {
      return helpers.data().helpers;
    },
  },

  /**
   * @Vue - Methods
   */
  methods: {
    system(app) {
      const context = this;

      return {
        /**
         * @desc
         * @param data -
         */
        encode(data) {
          return btoa(encodeURIComponent(stringify(data)));
        },

        /**
         * @desc
         * @param data -
         */
        decode(data) {
          return parse(decodeURIComponent(atob(data)));
        },

        /**
         * @desc
         * @param fileType -
         * @param fileName -
         * @param content -
         */
        saveFile(fileType, fileName, content) {
          const id = app.windowId || context._helpers.randid();

          localStorage.setItem(
            `file-${app.windowId}`,
            this.encode({
              id,
              fileType,
              fileName,
              content,
            })
          );
        },

        /**
         * @desc
         */
        getFiles() {
          const files = [];
          let f = 0;

          do {
            let file = null;
            const key = localStorage.key(f);
            const record =
              key && key.includes("file-") && localStorage.getItem(key);

            if (record) {
              try {
                file = this.decode(record);
              } catch (e) {
                console.warn("File cannot load(!)");
              }

              file && files.push({ type: APP_ITEM_TYPES.file, ...file });
            }

            f++;
            if (!key) f = null;
          } while (f !== null);

          if (files.length === 0) {
            files.push({
              type: APP_ITEM_TYPES.file,
              ...this.decode(aNote),
            });
          }

          return files;
        },

        /**
         * @desc
         */
        getApps() {
          const apps = Object.keys(Vue.options.components).filter((app) => {
            const component = Vue.options.components[app];
            return typeof component === "function" && component.options.config;
          });

          return apps.map((app) => ({
            type: APP_ITEM_TYPES.app,
            appConfig: {
              appName: app,
              ...Vue.options.components[app].options.config,
            },
          }));
        },
      };
    },
  },
};

const SaveComponentTemplate = `
  <div component="Save" :class="{shown: shown}" @keyup.enter="handleSaveClick" @keyup.esc="cancel">
    <div class="form">
      <div class="form-element">
        <span class="label">Filename</span>
        <input ref="input" v-model="fileName" placeholder="give a name to this file" type="text"></input>
      </div>
    </div>
    <button class="button" v-on:click="handleSaveClick">
      Save    
      <i class="gg-loadbar"></i>
    </button>
    <p class="close-info">ESC to cancel</p>
  </div>
`;
const SaveComponent = Vue.component("SaveComponent", {
  /**
   * @Vue -template
   */
  template: SaveComponentTemplate,

  /**
   * @Vue - mixins
   */
  mixins: [helpers],

  /**
   * @Vue - data
   */
  data() {
    return {
      shown: false,
      fileName: null,
      resolve: null,
      reject: null,
    };
  },

  /**
   * @Vue - methods
   */
  methods: {
    /**
     * @Event
     * @desc
     */
    handleSaveClick() {
      if (this.fileName && this.resolve) {
        this.resolve(this.fileName);
        this.setState(false);
      }
    },

    /**
     * @desc
     */
    run(file) {
      if (file) {
        this.fileName = file.fileName;
      }

      return new Promise((resolve, reject) => {
        this.setState(true, resolve, reject);
      });
    },

    /**
     * @desc
     */
    cancel() {
      this.setState(false);
    },

    /**
     * @desc
     * @param status -
     * @param resolve -
     * @param reject -
     */
    setState(status, resolve, reject) {
      if (status) {
        this.resolve = resolve;
        this.reject = reject;
      } else {
        this.resolve = null;
        this.reject = null;
      }

      this.disableContent(status);
      this.shown = status;
    },

    /**
     * @desc
     * @param disable -
     */
    disableContent(disable) {
      const appContent = this.$parent.$refs["app-content"];

      if (this.$parent && appContent) {
        if (disable) {
          appContent.style.filter = "blur(3px)";
          appContent.style.opacity = "0.5";
        } else {
          appContent.style.filter = null;
          appContent.style.opacity = null;
        }
      }
    },
  },
});

const ConfirmationComponentTemplate = `
  <div component="Confirmation" :class="{shown: shown}">
    {{ text }}
    <div class="actions">
      <button class="button default" v-on:click="handleCancelClick">
        Cancel
        <i class="gg-loadbar"></i>
      </button>
      <button class="button" v-on:click="handleYesClick">
        Yes
        <i class="gg-loadbar"></i>
      </button>
    </div>
  </div>
`;
const ConfirmationComponent = Vue.component("ConfirmationComponent", {
  /**
   * @Vue -template
   */
  template: ConfirmationComponentTemplate,

  /**
   * @Vue - mixins
   */
  mixins: [helpers],

  /**
   * @Vue - data
   */
  data() {
    return {
      shown: false,
      resolve: null,
      reject: null,
      text: null,
    };
  },

  /**
   * @Vue - methods
   */
  methods: {
    /**
     * @Event
     * @desc
     */
    handleCancelClick(e) {
      this.reject();
      this.setState(false);
    },

    /**
     * @Event
     * @desc
     */
    handleYesClick(e) {
      this.resolve();
      this.setState(false);
    },

    /**
     * @desc
     */
    run(text) {
      this.text = text;

      return new Promise((resolve, reject) => {
        this.setState(true, resolve, reject);
      });
    },

    /**
     * @desc
     */
    cancel() {
      this.setState(false);
    },

    /**
     * @desc
     * @param status -
     * @param resolve -
     * @param reject -
     */
    setState(status, resolve, reject) {
      if (status) {
        this.resolve = resolve;
        this.reject = reject;
      } else {
        this.resolve = null;
        this.reject = null;
      }

      this.disableContent(status);
      this.shown = status;
    },

    /**
     * @desc
     * @param disable -
     */
    disableContent(disable) {
      const appContent = this.$parent.$refs["app-content"];

      if (this.$parent && appContent) {
        if (disable) {
          appContent.style.filter = "blur(3px)";
          appContent.style.opacity = "0.5";
        } else {
          appContent.style.filter = null;
          appContent.style.opacity = null;
        }
      }
    },
  },
});

/**
 * @Component: Static Article
 * @from @souporserious https://codepen.io/souporserious/pen/xBpEj
 */
const EditorComponentTemplate = `
  <div component="Editor" @keyup.esc="handleCloseSaveModal" @keyup.ctrl.s="save" tabindex="0">
    <Save ref="saveModal" />
    <Confirm ref="confirmModal" />
    <div ref="app-content" class="app-content">
      <div class="component-actions">
        <a href="javascript:void(0);" data-role='bold' v-on:click="execute('bold')">B</a>
        <a href="javascript:void(0);" data-role='italic' v-on:click="execute('italic')">I</a>
        <a href="javascript:void(0);" data-role='underline' v-on:click="execute('underline')">U</a>
        <a href="javascript:void(0);" data-role='justifyleft' v-on:click="execute('justifyleft')"><i class="menu-left"></i></a>
        <a href="javascript:void(0);" data-role='justifycenter' v-on:click="execute('justifycenter')"><i class="menu-center"></i></a>
        <a href="javascript:void(0);" data-role='justifyright' v-on:click="execute('justifyright')"><i class="menu-right"></i></a>
        <a v-if="touched" v-on:click="handleSaveClick" class="save">
          Save
          <i class="gg-check-o" />
        </a>
      </div>
      <div ref="content" class="editor-content" contenteditable @input="handleContentInput" v-html="content"></div>
    </div>
  </div>
`;
const EditorComponent = Vue.component("EditorComponent", {
  /**
   * @Vueos - config
   */
  config: {
    ext: APP_FILE_TYPES.vuedit,
    name: "Vuedit",
    icon: "gg-format-text",
    appIcon: "note",
  },

  components: { Save: SaveComponent, Confirm: ConfirmationComponent },

  /**
   * @Vue - template
   */
  template: EditorComponentTemplate,

  /**
   * @Vue - mixins
   */
  mixins: [helpers, system],

  /**
   * @Vue - props
   */
  props: {
    windowId: {
      type: String,
      default: null,
    },
    file: {
      type: Object,
      default: null,
    },
    window: {
      type: Object,
      default: null,
    },
  },

  /**
   * @Vue - created
   */
  created() {
    if (this.file) {
      this.content = this.file.content;
    }
  },

  /**
   * @Vue - data
   */
  data() {
    return {
      content: "",
      touched: false
    };
  },

  watch: {
    touched(n, o) {
      if (n) {
        this.window.title = this.window.title + " *";
      } else {
        this.window.title = this.window.title.replace(" *", "");
      }
    }
  },

  /**
   * @Vue - methods
   */
  methods: {
    /**
     * @Event
     * @desc
     */
    handleSaveClick() {
      this.save();
    },

    /**
     * @Event
     * @desc Closes save model when
     * 'escape' key pressed up
     */
    handleCloseSaveModal(e) {
      this.$refs.saveModal.cancel();
    },

    /**
     * @Event
     * @desc
     */
    handleContentInput(e) {
      this.touched = true;
    },

    /**
     * @desc
     * @param filename -
     */
    saveToDisk(fileName) {
      const content = this.$refs.content.innerHTML;
      this.system(this).saveFile(APP_FILE_TYPES.vuedit, fileName, content);
      this.$emit("on-save", this.windowId);
    },

    /**
     * @desc
     *
     */
    save() {
      if (!this.touched || this.$refs.confirmModal.shown) return;

      if (!this.file) {
        this.$refs.saveModal.run().then((fileName) => {
          this.saveToDisk(fileName);
          this.touched = false;
        });
      } else {
        this.saveToDisk(this.file.fileName);
        this.touched = false;
      }
    },

    /**
     * @desc
     * @param command -
     */
    execute(command) {
      document.execCommand(command, false);
    },

    /**
     * @desc
     */
    onWindowClose(cb) {
      const text = "You have unsaved changes.Do you still want to close?";

      if (this.$refs.saveModal.shown) return;

      if (this.touched) {
        this.$refs.confirmModal.run(text).then(cb, () => {});
        return;
      }
      cb();
    },

    /**
     * @desc
     */
    onWindowKeyUp(e) {
      if (e.ctrlKey && e.key === "s") {
        this.save();
      }

      if (e.key === "Escape") {
        this.handleCloseSaveModal();
        this.$refs.confirmModal.cancel();
      }
    }
  }
});

/**
 * @Component: Static Article
 * @from @ovens https://codepen.io/ovens/pen/EeprWN
 */
const ArticleComponentTemplate = `
  <div>
    <div v-bind:style="style.p" v-for="(v, idx) in [0,0,0,0,0,0]" v-html="sentence(idx)">
    </div>
  </div>
`;
const ArticleComponent = Vue.component("ArticleComponent", {
  /**
   * @Vueos - config
   */
  config: {
    ext: APP_FILE_TYPES.story,
    name: "Unreal Story",
    icon: "gg-file-document",
    appIcon: "story",
  },

  /**
   * @Vue - template
   */
  template: ArticleComponentTemplate,

  /**
   * @Vue - mixins
   */
  mixins: [helpers],

  /**
   * @Vue - props
   */
  props: {},

  /**
   * @Vue - data
   */
  data() {
    return {
      n: [
        "bird",
        "clock",
        "boy",
        "plastic",
        "duck",
        "teacher",
        "old lady",
        "professor",
        "hamster",
        "dog",
      ],
      v: [
        "kicked",
        "ran",
        "flew",
        "dodged",
        "sliced",
        "rolled",
        "died",
        "breathed",
        "slept",
        "killed",
      ],
      a: [
        "beautiful",
        "lazy",
        "professional",
        "lovely",
        "dumb",
        "rough",
        "soft",
        "hot",
        "vibrating",
        "slimy",
      ],
      b: [
        "slowly",
        "elegantly",
        "precisely",
        "quickly",
        "sadly",
        "humbly",
        "proudly",
        "shockingly",
        "calmly",
        "passionately",
      ],
      p: [
        "down",
        "into",
        "up",
        "on",
        "upon",
        "below",
        "above",
        "through",
        "across",
        "towards",
      ],
      content: "",
      style: {
        p: {
          color: "#efefef",
          fontWeight: 300,
          fontSize: "13px",
          marginBottom: "10px",
          lineHeight: "1.8em",
        },
      },
    };
  },

  /**
   * @Vue - methods
   */
  methods: {
    /**
     * @desc
     * @param max -
     */
    rand(max) {
      return Math.floor(Math.random() * max) + 1;
    },

    /**
     * @desc
     * @param total -
     * @param randMax -
     */
    fillRand(total, randMax) {
      return [...Array(total)].map((_) => this.rand(randMax));
    },

    /**
     * @desc
     * @param idx -
     */
    sentence(idx) {
      let text = "";
      const totalWord = this.rand(5);

      for (let s = 0; s <= totalWord; s++) {
        const [r1, r2, r3, r4, r5, r6] = this.fillRand(6, 10);

        text +=
          (idx === 0 ? "The " : "") +
          this.a[r1] +
          " " +
          this.n[r2] +
          " " +
          this.b[r3] +
          " " +
          this.v[r4] +
          " because some " +
          this.n[r1] +
          " " +
          this.b[r1] +
          " " +
          this.v[r1] +
          " " +
          this.p[r1] +
          " a " +
          this.a[r2] +
          " " +
          this.n[r5] +
          " which, became a " +
          this.a[r3] +
          ", " +
          this.a[r4] +
          " " +
          this.n[r6] +
          ".";
      }

      return text;
    },
  },
});

/**
 * @Component: Vrush - Paint
 * @from @tholman https://codepen.io/tholman/pen/ifDak
 */
const VrushComponentTemplate = `
  <div component="Vrush">
    <Save ref="saveModal" />
    <Confirm ref="confirmModal" />
    <div ref="app-content">
      <div class="component-actions">
        <a :style="[touched ? { opacity: 1 } : { opacity: 0.3, pointerEvents: 'none' }]" @click="handleSaveClick" class="save">
          Save
          <i class="gg-check-o" />
        </a>
      </div>
      <span v-if="!file && !firstMove" class="info">Draw something</span>
      <canvas
        ref="canvas"
        @mousemove="handleMouseMove"
        @mousedown="handleMouseDown"
        @mouseup="handleMouseUp"
        @click="handleClick"
        @dblclick="handleDblclick"
        id='canvas'
      ></canvas>
    </div>
  </div>
`;
const VrushComponent = Vue.component("VrushComponent", {
  /**
   * @Vueos - config
   */
  config: {
    ext: APP_FILE_TYPES.vrush,
    name: "Vrush",
    icon: "gg-brush",
    appIcon: "brush",
  },

  /**
   * @Vue - template
   */
  template: VrushComponentTemplate,

  /**
   * @Vue - mixins
   */
  mixins: [helpers, system],

  /**
   * @Vue - components
   */
  components: { Save: SaveComponent, Confirm: ConfirmationComponent },

  /**
   * @Vue - props
   */
  props: {
    windowId: {
      type: String,
      default: null,
    },
    window: {
      type: Object,
      default: null,
    },
    file: {
      type: Object,
      default: null,
    },
  },

  /**
   * @Vue - data
   */
  data() {
    return {
      pressed: false,
      touched: false,
      firstMove: false,
      context: null,
      imageData: null,
      startPos: { x: 0, y: 0 },
      prevPos: { x: null, y: null },
      dist: { x: 0, y: 0 },
      colour: null,
      style: {},
    };
  },

  /**
   * @Vue - mounted
   */
  mounted() {
    this.context = this.$refs.canvas.getContext("2d");
  },

  /**
   * @Vue - created
   */
  created() {
    if (this.file) {
      this.imageData = this.file.content;
    }
  },

  /**
   * @Vue - watch
   */
  watch: {
    'prevPos.x': function(n, o) {
      if (o === null) return;
      this.touched = true;
    },
    touched(n, o) {
      if (n) {
        this.window.title = this.window.title + " *";
      } else {
        this.window.title = this.window.title.replace(" *", "");
      }
    }
  },

  /**
   * @Vue - methods
   */
  methods: {
    /**
     * @Event
     * @desc
     */
    handleSaveClick() {
      this.save();
    },

    /**
     * @Event Mouse Move
     * @desc
     */
    handleMouseMove(e) {
      if (!this.pressed) return;

      const { context, prevPos, startPos, dist, colour } = this;
      
      const distance = Math.sqrt(
        Math.pow(prevPos.x - startPos.x, 2) +
          Math.pow(prevPos.y - startPos.y, 2)
      );
      const a = distance * 10 * (Math.pow(Math.random(), 2) - 0.5);
      const r = Math.random() - 0.5;
      const size = (Math.random() * 15) / distance;

      this.firstMove = true;

      dist.x = (prevPos.x - startPos.x) * Math.sin(0.5) + startPos.x;
      dist.y = (prevPos.y - startPos.y) * Math.cos(0.5) + startPos.y;

      startPos.x = prevPos.x;
      startPos.y = prevPos.y;

      prevPos.x = e.pageX - (this.window.offset.left);
      prevPos.y = e.pageY - (this.window.offset.top) - 45;

      // ------- Draw -------
      const lWidth =
        (Math.random() + 20 / 10 - 0.5) * size +
        (1 - Math.random() + 30 / 20 - 0.5) * size;
      context.lineWidth = lWidth;
      context.strokeWidth = lWidth;

      context.lineCap = "round";
      context.lineJoin = "round";

      context.beginPath();
      context.moveTo(startPos.x, startPos.y);
      context.quadraticCurveTo(dist.x, dist.y, prevPos.x, prevPos.y);

      context.fillStyle = colour;
      context.strokeStyle = colour;

      context.moveTo(startPos.x + a, startPos.y + a);
      context.lineTo(startPos.x + r + a, startPos.y + r + a);

      context.stroke();
      context.fill();

      context.closePath();
    },

    /**
     * @desc
     */
    handleMouseDown(e) {
      this.pressed = true;

      this.prevPos = {
        x: e.pageX - (this.window.offset.left),
        y: e.pageY - (this.window.offset.top) - 45
      };
    },

    /**
     * @desc
     */
    handleMouseUp() {
      this.pressed = false;
    },

    /**
     * @Event Click
     * @desc
     */
    handleClick() {
      this.colour = this.getRandomColour();
      this.context.fillStyle = this.colour;
      this.context.strokeStyle = this.colour;
    },

    /**
     * @Event Double Click
     * @desc
     */
    handleDblclick() {
      this.context.clearRect(0, 0, this.$refs.canvas.width, this.$refs.canvas.height);
    },

    /**
     * @desc
     * @param filename -
     */
    saveToDisk(fileName) {
      const content = this.$refs.canvas.toDataURL();
        
      this.system(this).saveFile(APP_FILE_TYPES.vrush, fileName, content);
      this.$emit("on-save", this.windowId);
    },

    /**
     * @desc
     */
    save() {
      if (!this.file) {
        !this.$refs.confirmModal.shown && this.$refs.saveModal.run().then((fileName) => {
          this.saveToDisk(fileName);
          this.touched = false;
        });
      }
      else {
        this.saveToDisk(this.file.fileName);
        this.touched = false;
      }
    },

    /**
     * @desc
     */
    getRandomColour() {
      return "#" + Math.floor(Math.random() * 16777215).toString(16);
    },
    

    /**
     * @desc
     */
    updateScene(init) {
      const { width, height } = this.window.cssVariables.bounds;

      this.$refs.canvas.width = width;
      this.$refs.canvas.height = height;

      if (init) {
        this.startPos = { x: width / 2, y: height / 2 };
        this.colour = this.getRandomColour();

        if (this.imageData) {
          const image = new Image();
          
          image.onload = () => {
            this.context.drawImage(image, 0, 0);
          }
          image.src = this.imageData;
        }
      }
    },

    /**
     * @desc
     */
    onWindowResize() {},

    /**
     * @desc
     */
    onWindowReady() {
      this.updateScene(true);
    },

    /**
     * @desc
     */
    onWindowClose(cb) {
      const text = "You have unsaved changes. Do you still want to close?";

      if (this.$refs.saveModal.shown) return;

      if (this.touched) {
        this.$refs.confirmModal.run(text).then(cb, () => {});
        return;
      }
      cb();
    },

    /**
     * @desc
     */
    onWindowKeyUp(e) {
      if (e.ctrlKey && e.key === "s") {
        this.save();
      }

      if (e.key === "Escape") {
        this.$refs.saveModal.cancel();
        this.$refs.confirmModal.cancel();
      }
    }
  },
});

export default {
  /**
   * @Vue - Mixins
   */
  mixins: [helpers, system],

  /**
   * @Vue - Data
   * -
   */
  data() {
    const uiDefaultTaskbar = {
      verticalGap: 20,
      horizontalGap: 20,
      height: 60,
    };

    const uiDefaultWindow = {
      minimizedAnimDuration: "0.35s",
      minimizedWidth: 250,
      minimizedHeight: 45,
      minimizedGap: 20,
    };

    const uiDefaultFile = {
      width: 100,
      height: 100,
    };

    const taskbarBounds = {
      x: null,
      y: null,
      w: null,
      h: null,
    };

    return {
      windows: [],
      files: [],
      apps: [],
      folders: [],
      items: [],
      minimizedWindows: [],
      windowFocusSequence: [],
      activeItem: null,
      mouseState: MOUSE_STATES.UP,
      ui: {
        itemDefaults: {
          cssVariables: {},
          drag: { x: 0, y: 0 },
          offset: { top: 0, left: 0 },
        },
        default: {
          taskbar: uiDefaultTaskbar,
          window: uiDefaultWindow,
          file: uiDefaultFile,
        },
        taskbar: {
          bounds: taskbarBounds,
        },
      },
    };
  },

  /**
   * @Vue - Computed
   * -
   */
  computed: {},

  /**
   * @Vue - Watch
   * -
   */
  watch: {
    /**
     * @Watch
     * @desc update window focues sequence every
     * activeItem change
     */
    activeItem(newValue, oldValue) {
      newValue &&
        newValue.type &&
        newValue.type === APP_ITEM_TYPES.window &&
        this.updateWindowFocusSequence(newValue.id);
    },
  },

  /**
   * @Vue - beforeCreate
   */
  created() {
    // Get vueos apps
    // #
    this.apps = this.system(this).getApps();

    // Get files from hdd :)
    // #
    this.files = this.system(this).getFiles();

    this.items = [...this.apps, ...this.files];

    this.items.forEach((item) => {
      Object.keys(this.ui.itemDefaults).forEach((d) => {
        item[d] = this.ui.itemDefaults[d];
      });

      !item.id && (item.id = this.helpers.randid());
    });
  },

  /**
   * @Vue - Mounted
   * -
   */
  mounted() {
    this.globalEvents();

    this.createWindow("Unreal Story", VrushComponent, 250, 100);

    this.$nextTick(() => {
      this.setUiParameters();
      this.organizeItems();
    });
  },

  /**
   * @Vue - Updated
   * -
   */
  updated() {},

  /**
   * @Vue - Methods
   * -
   */
  methods: {
    globalEvents() {
      /**
       *
       * [ Native Event: Resize --> window ]
       */
      window.addEventListener("resize", this.handleBrowserWindowResize);
    },

    /**
     * @Event Resize
     * @desc Window Resize
     */
    handleBrowserWindowResize() {
      this.$nextTick(() => {
        this.setUiParameters();
        this.organizeItems();
        this.organizeMinimizedWindows();
      });
    },

    /**
     * @Event MouseMove
     * @desc
     */
    handleMouseMove: function (e) {
      if (
        this.activeItem &&
        this.mouseState == MOUSE_STATES.DOWN &&
        ((this.activeItem.type === APP_ITEM_TYPES.window &&
          !this.isWindowMinimized(this.activeItem.id) &&
          !this.isWindowMaximized(this.activeItem.id)) ||
          this.activeItem.type === APP_ITEM_TYPES.file ||
          this.activeItem.type === APP_ITEM_TYPES.app)
      ) {
        this.activeItem.offset.top = e.pageY - this.activeItem.drag.y;
        this.activeItem.offset.left = e.pageX - this.activeItem.drag.x;
        this.$forceUpdate();
      }
    },

    /**
     * @Event MouseDown
     * @desc
     */
    handleMouseDown(e) {
      if (
        e.target &&
        (e.target.classList.contains("window-controls") ||
          e.target.closest(".desktop-item"))
      ) {
        this.mouseState = MOUSE_STATES.DOWN;
        this.activeItem.drag.x = e.pageX - this.activeItem.offset.left;
        this.activeItem.drag.y = e.pageY - this.activeItem.offset.top;
      }
    },

    /**
     * @Event MouseUp
     * @desc
     */
    handleMouseUp() {
      if (!this.activeItem) return;

      this.mouseState = MOUSE_STATES.UP;
      this.activeItem.offset.top < -20 && (this.activeItem.offset.top = 0);
      this.activeItem.userInteracting = false;
    },

    /**
     * @Event MouseDown
     * @desc
     */
    handleWindowMouseDown(id) {
      const window = this.windows.find((w) => w.id === id);
      this.activeItem = window;
      this.activeItem.userInteracting = true;
    },

    /**
     * @Event MouseDown
     * @desc
     */
    handleWindowContentMouseDown(id) {
      const window = this.windows.find((w) => w.id === id);
      window.userInteracting = true;
    },

    /**
     * @Event MouseUp
     * @desc
     */
    handleWindowContentMouseUp(id) {
      const window = this.windows.find((w) => w.id === id);
      window.userInteracting = false;
    },

    /**
     * @Event Resize
     * @desc
     */
    handleWindowResize(record, window, contentDomRef) {
      window.cssVariables.bounds = {
        width: contentDomRef.offsetWidth,
        height: contentDomRef.offsetHeight,
      };

      this.$forceUpdate();
    },

    /**
     * @Event Init
     * @desc
     */
    handleWindowContentInit(id) {
      this.$nextTick(() => {
        if (!this.$refs.window) return true;
        const window = this.windows.find((w) => w.id === id);

        if (window.ready) return true;

        if (window && !window.resizeObserver) {
          const domRef = this.$refs.window.find(
            (w) => w.getAttribute('v-id') === id
          );
          const content = domRef && domRef.querySelector(".content");

          if (!domRef || !content) {
            return true;
          }

          /**
           *
           * [Observer: Mutation --> window ]
           */
          window.resizeObserver = new MutationObserver((record) => {
            this.handleWindowResize(record, window, content);
            this.callComponentMethod(`window-${id}`, 'onWindowResize');
          });

          window.resizeObserver.observe(content, {
            attributes: true,
            attributeFilter: ["style"],
          });

          if (!window.cssVariables.bounds) {
            this.handleWindowResize(null, window, domRef);
          }
        }
        
        window.ready = true;
        this.callComponentMethod(`window-${id}`, 'onWindowReady');
        
        return true;
      });
    },

    callComponentMethod(refId, func, ...params) {
      const component = this.$refs[refId];

      if (component &&
          component[0] &&
          component[0][func] &&
          typeof component[0][func] === 'function'
        ) {
          component[0][func].apply(this, params);
        }
    },

    /**
     * @Event MouseDown
     * @desc
     */
    handleFileMouseDown(id) {
      const item = this.items.find((i) => i.id === id);
      this.activeItem = item;
    },

    /**
     * @Event Click
     * @desc
     */
    handleFileClick(id) {},

    /**
     * @Event Double Click
     * @desc
     */
    handleFileDoubleClick(id) {
      const item = this.items.find((i) => i.id === id);

      if (item.type === APP_ITEM_TYPES.app) {
        this.openApp(item);
      } else if (item.type === APP_ITEM_TYPES.file) {
        this.openFile(item);
      }
    },

    /**
     * @Event Click
     * @desc
     */
    handleVueClick() {},

    /**
     * @Event On Save
     * @desc
     */
    handleAppOnSave(fileId) {
      const wIdx = this.windows.findIndex((w) => w.id === fileId);
      const item = this.items.find((i) => i.id === fileId);
      const file = this.system(this).decode(
        localStorage.getItem(`file-${fileId}`)
      );

      if (item) {
        item.content = file.content;
      } else {
        Object.keys(this.ui.itemDefaults).forEach((d) => {
          file[d] = this.ui.itemDefaults[d];
        });

        file.type = APP_ITEM_TYPES.file;
        file.new = true;

        const idx = this.items.push(file) - 1;

        this.items[idx].offset = this.getDesktopItemPosition(idx);
        this.windows[wIdx].fileId = fileId;
      }
    },

    /**
     * @Event KeyUp
     * @param id -
     * @desc
     */
    handleWindowKeyUp(e, id) {
      const ref = this.$refs[`window-${id}`];

      if (
        ref &&
        ref[0] &&
        ref[0].onWindowKeyUp &&
        typeof ref[0].onWindowKeyUp === "function"
      ) {
        ref[0].onWindowKeyUp(e);
      }
    },

    /**
     * @desc
     * @param file -
     */
    openFile(file) {
      const app = this.apps.find((app) => app.appConfig.ext === file.fileType);
      const fileOpened = this.windows.find((w) => w.id === file.id);

      if (app && !fileOpened) {
        this.openApp(app, file);
      }

      if (fileOpened) {
        // focus window
      }
    },

    /**
     * @desc
     * @param app -
     * @param file -
     */
    openApp(app, file) {
      const { name, appName } = app.appConfig;
      const component = Vue.options.components[appName];
      const title = name + ((file && " - " + file.fileName) || "");

      if (component) {
        this.createWindow(
          title,
          component,
          null,
          null,
          (file && file.id) || null
        );
      }
    },

    /**
     * @desc Creates new window
     */
    createWindow(title, component, x, y, id) {
      const lastFocusedWindowId = this.windowFocusSequence.slice(-1)[0];
      const lastFocusedWindow = this.windows.find(
        (w) => w.id === lastFocusedWindowId
      );

      // Re-position new window
      // after last focused window
      if (lastFocusedWindow) {
        !x && (x = lastFocusedWindow.offset.left + 20);
        !y && (y = lastFocusedWindow.offset.top + 20);
      }

      const window = {
        id: id || this.helpers.randid(),
        type: APP_ITEM_TYPES.window,
        title,
        component,
        ready: false,
        fileId: id,
        minimized: false,
        userInteracting: false,
        resizeObserver: null,
        drag: { x: 0, y: 0 },
        offset: {
          top: y || 170,
          left: x || 170,
        },
        cssVariables: {},
      };

      const idx = this.windows.push(window) - 1;

      this.windows[idx].idx = idx;
      this.activeItem = this.windows[idx];
      this.updateWindowFocusSequence(window.id);

      return this.windows[idx];
    },

    /**
     * @desc
     */
    setUiParameters() {
      const rectTaskbar = this.$refs.taskbar.getBoundingClientRect();

      this.ui.taskbar.bounds = {
        x: rectTaskbar.x,
        y: rectTaskbar.y,
        w: rectTaskbar.width,
        h: rectTaskbar.height,
      };
    },

    /**
     * @desc Recursive css variable string or list builder from
     * nested objects list
     * @param obj - object list
     * @param prefix - prefix
     */
    cssVarsGenerator(obj, type = "string") {
      /**
       * @desc Example output: '--prop-val: val; --prop-val2: val'
       */
      const stringGenerator = (obj) => {
        const generator = (obj, prefix) => {
          let str = "";
          Object.keys(obj).forEach((key, idx) => {
            const value = Object.values(obj)[idx];

            typeof value === "object" && value
              ? (str += generator(value, prefix ? `${prefix}-${key}` : key))
              : (str += prefix
                  ? (!!value && "") || `--${prefix}-${key}:${value};`
                  : (!!value && "") || `--${key}:${value};`);
          });
          return str;
        };
        return generator(obj);
      };

      /**
       * @desc Example output: {
       *  '--prop-val': val',
       *  '--prop-val2': 'val'
       * }
       */
      const listGenerator = (obj) => {
        const list = {};
        const stringified = stringGenerator(Object.assign({}, obj));

        stringified.split(";").forEach((rule) => {
          if (rule) {
            const [key, value] = rule.split(":");
            list[key] = value;
          }
        });

        return list;
      };

      return type !== "string" ? listGenerator(obj) : stringGenerator(obj);
    },

    /**
     * @desc Generates one string css
     * variables from object list
     */
    uiVariables() {
      let variables = {
        taskbar: {
          x: this.ui.taskbar.bounds.x,
          y: this.ui.taskbar.bounds.y,
          w: this.ui.taskbar.bounds.w,
          h: this.ui.taskbar.bounds.h,
        },
        ...this.ui.default,
      };

      return this.cssVarsGenerator(variables);
    },

    /**
     * @desc Generates styles for window
     * @param idx -
     */
    windowUiVariables(idx) {
      const window = this.windows[idx];
      let posx = window.offset.left;
      let posy = window.offset.top;

      return {
        transform: `translate(${posx}px, ${posy}px)`,
        zIndex: this.windowFocusSequence.findIndex((wId) => wId === window.id),
        ...this.cssVarsGenerator(window.cssVariables, "list"),
      };
    },

    /**
     * @desc Generates style for desktop items
     * @param idx -
     */
    desktopItemUiVariables(idx, id) {
      const item = this.items[idx];
      let posx = item.offset.left;
      let posy = item.offset.top;

      return {
        transform: `translate(${posx}px, ${posy}px)`,
        zIndex: this.activeItem && this.activeItem.id === item.id ? 1 : 0,
        ...this.cssVarsGenerator(item.cssVariables, "list"),
      };
    },

    /**
     * @desc
     * @param id -
     */
    isWindowMinimized(id) {
      return this.minimizedWindows.findIndex((wmId) => wmId === id) !== -1;
    },

    /**
     * @desc
     * @param id -
     */
    isWindowMaximized(id) {
      const idx = this.windows.findIndex((w) => w.id === id);
      return this.windows[idx].maximized;
    },

    /**
     * @desc
     * @param Id -
     */
    updateWindowFocusSequence(id) {
      const windowIdx = this.windowFocusSequence.findIndex((wId) => wId === id);

      if (windowIdx === -1) {
        this.windowFocusSequence.push(id);
      } else {
        this.$delete(this.windowFocusSequence, windowIdx);
        this.windowFocusSequence.push(id);
      }
    },

    /**
     * @desc
     * @param id -
     */
    organizeMinimizedWindows() {
      const uiDefaults = this.ui.default.window;

      /**
       * @desc
       * @param parentWidth -
       */
      const calculateWidth = (parentWidth) => {
        const defaultWidth =
          uiDefaults.minimizedWidth + uiDefaults.minimizedGap;
        const minimizedWindows = this.minimizedWindows.length;

        if (defaultWidth * minimizedWindows > parentWidth) {
          return parentWidth / minimizedWindows - uiDefaults.minimizedGap;
        }

        return uiDefaults.minimizedWidth;
      };

      this.minimizedWindows.forEach((mwId, idx) => {
        const windowIdx = this.windows.findIndex((w) => w.id === mwId);
        const rectVue = this.$refs.vue.getBoundingClientRect();
        const boundsTaskbar = this.ui.taskbar.bounds;
        const height = uiDefaults.minimizedHeight;
        const width = calculateWidth(boundsTaskbar.w - rectVue.width);

        const baseX =
          boundsTaskbar.x +
          boundsTaskbar.w -
          rectVue.width -
          width -
          uiDefaults.minimizedGap;

        const x = baseX - uiDefaults.minimizedGap * idx - width * idx;

        const y =
          boundsTaskbar.y +
          boundsTaskbar.h / 2 -
          uiDefaults.minimizedHeight / 2;

        this.windows[windowIdx].cssVariables.minimized = {
          x: `${x}px`,
          y: `${y}px`,
          width: `${width}px`,
          height: `${height}px`,
        };
      });
    },

    /**
     * @desc
     */
    organizeItems() {
      this.items.map((item, idx) => {
        item.offset = this.getDesktopItemPosition(idx);
        return item;
      });
    },

    /**
     * @desc
     * @param idx -
     */
    getDesktopItemPosition(idx) {
      const grid = this.getDesktopGrid();
      const column =
        this.items.length > grid.totalItemsInColumn
          ? parseInt(idx / (grid.totalItemsInColumn % this.items.length))
          : 0;
      const startTop = grid.top + 20;
      const top =
        (idx % grid.totalItemsInColumn) * this.ui.default.file.height +
        startTop;
      const left = column * this.ui.default.file.width + 20;

      return { top, left };
    },

    /**
     * @desc
     */
    getDesktopGrid() {
      const { h: taskbarBoundsH } = this.ui.taskbar.bounds;
      const [wW, wH] = [window.innerWidth, window.innerHeight];
      const top = this.ui.default.taskbar.verticalGap * 2 + taskbarBoundsH;
      const totalItemsInRow = parseInt(wW / this.ui.default.file.width);
      const totalItemsInColumn = parseInt(
        (wH - top) / this.ui.default.file.height
      );

      return { top, totalItemsInRow, totalItemsInColumn };
    },

    /**
     * @desc
     * @param item -
     */
    getExt(item) {
      if (item.type === APP_ITEM_TYPES.file) {
        return "." + item.fileType;
      }

      return "";
    },

    /**
     * @desc
     * @param item -
     */
    getName(item) {
      let name =
        item.type === APP_ITEM_TYPES.app
          ? item.appConfig.name
          : item.fileName + this.getExt(item);
      return name;
    },

    /**
     * @desc
     * @param item -
     */
    getIcon(item) {
      let icon =
        (item.type === APP_ITEM_TYPES.app && item.appConfig.appIcon) || "";

      if (item.type === APP_ITEM_TYPES.file) {
        const app = this.apps.find(
          (app) => app.appConfig.ext === item.fileType
        );

        icon = (app && app.appConfig.icon) || "";
      }

      return icon;
    },

    /**
     * @desc
     * @item item -
     */
    getAppIcon(item) {
      let icon = this.$refs["icon-" + item.appConfig.appIcon] || "";

      if (icon) {
        return icon.innerHTML;
      }

      return icon;
    },

    /**
     * @desc
     * @param fileId -
     */
    getFile(fileId) {
      if (!fileId) return;
      const file = this.items.find((file) => file.id === fileId);

      if (file) {
        return file;
      }
    },

    /**
     * @desc
     */
    setActiveWindow(idx) {
      this.activeItem = this.windows[idx];
    },

    /**
     * @desc
     * @param id -
     */
    toggleWindowMinimize(id) {
      const idx = this.windows.findIndex((w) => w.id === id);
      const minimizedIdx = this.minimizedWindows.findIndex(
        (wmId) => wmId === id
      );

      if (this.windows[idx].maximized) {
        this.toggleWindowMaximize(id);
      }

      if (minimizedIdx !== -1) {
        this.$delete(this.minimizedWindows, minimizedIdx);
      } else {
        this.minimizedWindows.push(id);
      }

      this.organizeMinimizedWindows();
    },

    /**
     * @desc
     * @param id -
     */
    toggleWindowMaximize(id) {
      const idx = this.windows.findIndex((w) => w.id === id);
      const isMinimized = this.isWindowMinimized(this.activeItem.id);

      if (isMinimized) {
        this.handleWindowMinimize(id);
      }

      this.windows[idx].maximized = !this.windows[idx].maximized;
      this.$forceUpdate();
    },

    /**
     * @desc
     * @param id -
     */
    closeWindow(id) {
      const idx = this.windows.findIndex((w) => w.id === id);
      const minimizedIdx = this.minimizedWindows.findIndex(
        (mwId) => mwId === id
      );
      const focusSequenceIdx = this.windowFocusSequence.findIndex(
        (wfsId) => wfsId === id
      );

      this.$delete(this.windows, idx);

      if (focusSequenceIdx !== -1) {
        this.$delete(this.windowFocusSequence, focusSequenceIdx);
      }

      if (minimizedIdx !== -1) {
        this.$delete(this.minimizedWindows, minimizedIdx);
        this.organizeMinimizedWindows();
      }

      if (!this.windows.length) {
        this.activeItem = null;
        return;
      }

      // Make last focused window active
      // #
      if (!!this.windows.length && this.activeItem.id === id) {
        const lastFocusedWindow = this.windowFocusSequence.slice(-1).pop();
        const availableWindows = this.windows.filter(
          (w) => !this.isWindowMinimized(w.id)
        );

        // If all windows are minimized
        // set last focused window active
        if (!availableWindows.length) {
          this.setActiveWindow(
            this.windows.findIndex((w) => w.id === lastFocusedWindow)
          );
          return;
        }

        // Otherwise set last focused
        // window from not minimized ones
        const targetWindow = this.windowFocusSequence
          .filter((wId) => availableWindows.find((aW) => aW.id === wId))
          .slice(-1)
          .pop();

        this.setActiveWindow(
          this.windows.findIndex((w) => w.id === targetWindow)
        );
      }
    },

    /**
     * @desc
     * @param id -
     */
    handleWindowMinimize(id) {
      this.toggleWindowMinimize(id);
    },

    /**
     * @desc
     * @param idx -
     */
    handleWindowMaximize(id) {
      this.toggleWindowMaximize(id);
    },

    /**
     * @desc
     * @param id -
     * @param force -
     */
    handleWindowClose(id, force) {
      const ref = this.$refs[`window-${id}`];

      if (
        ref &&
        ref[0] &&
        ref[0].onWindowClose &&
        typeof ref[0].onWindowClose === "function" &&
        !force
      ) {
        ref[0].onWindowClose(() => this.closeWindow(id));
        return false;
      }

      this.closeWindow(id);
    },
  },
};
</script>

<style lang="scss">
@import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,900;1,500&display=swap");
@import url("https://unpkg.com/css.gg/icons/all.css");
/**
    * Sass Constants
    */
$z: 8888;

/**
    * Sass Mixins
    */
@mixin scrollbar() {
  &::-webkit-scrollbar {
    width: 4px;
    height: 4px;
  }
  &::-webkit-scrollbar-thumb {
    background: transparentize(#96ff60, 0.8);
    border-radius: 15px;
    cursor: pointer;
  }
  &::-webkit-scrollbar-thumb:hover {
    background: #96ff60;
  }
  &::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0);
    border-radius: 15px;
  }
}

:root {
  --bg: url("https://4kwallpapers.com/images/wallpapers/lake-mountains-rocks-twilight-sunset-starry-sky-purple-sky-1920x1080-3768.jpg");
  --primary-bg-color: rgba(16, 18, 27, 0.7);
  --primary-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.75);
  --primary-text-shadow: 0 0 3px rgb(0 0 0 / 75%);
  --window-radius: 18px;
  --vueos-transition-fn: cubic-bezier(0.19, 1, 0.22, 1);
}

* {
  box-sizing: border-box;
}

[tabindex]:focus {
  outline: none;
}

body {
  display: flex;
  justify-content: center;
  background: transparent var(--bg) no-repeat center center / cover;
  min-height: 100vh;
  margin: 0;
  padding: 0;
  font-family: "Roboto", sans-serif;
  overflow: hidden;
}

#app {
  position: relative;
  width: 100%;
  padding: 20px;
}

/* ------ --------- ----------
    * Window Component 
    * ------ --------- --------
    */
.windows {
  position: fixed;
  top: 0;
  left: 0;
  z-index: $z;
}

/* ------ --------- ----------
    * Window Component 
    * ------ --------- --------
    */
.window {
  position: fixed;
  background-color: var(--primary-bg-color);
  border-radius: var(--window-radius);
  box-shadow: var(--primary-shadow);
  transition: transform 0.5s var(--vueos-transition-fn),
    width 0.35s var(--vueos-transition-fn) !important;
  transform-origin: 0% 100%;
  width: calc((var(--bounds-width) * 1px));
  overflow: hidden;
  @supports (backdrop-filter: blur(20px)) {
    backdrop-filter: blur(20px);
  }
  @supports not (backdrop-filter: blur(20px)) {
    background-color: rgba(16, 18, 27, 0.95);
  }
}

/* ------ --------- ----------
    * Window Component: Controls 
    * ------ --------- --------
    */
.window .window-controls {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 10px;
  cursor: move;
  height: 45px;
  .title {
    white-space: nowrap;
    padding: 0 10px;
    color: #ffffff;
    pointer-events: none;
    user-select: none;
    width: calc(100% - 70px);
    text-overflow: ellipsis;
    overflow: hidden;
  }
  .buttons {
    position: absolute;
    top: 50%;
    right: 0;
    display: flex;
    justify-content: flex-end;
    width: 70px;
    transform: translateY(-50%);
  }
  .buttons .button {
    display: block;
    flex: 0 0 15px;
    max-width: 15px;
    height: 15px;
    border-radius: 5px;
    margin-right: 8px;
    cursor: pointer;
  }
  .close {
    background-color: #f96057;
  }
  .minimize {
    background-color: #f8ce52;
  }
  .fullscreen {
    background-color: #5fcf65;
  }
}

/* ------ --------- ----------
    * Window Component: Content 
    * ------ --------- --------
    */
.window .content {
  width: 450px;
  height: 450px;
  min-width: 200px;
  min-height: 100px;
  resize: both;
  overflow: auto;
  padding: 0 20px 20px 20px;
  opacity: 0.7;
  transition: opacity 0.2s ease;
  @include scrollbar();
  @at-root {
    .window.active .content {
      opacity: 1;
    }
  }
}

/* ------ --------- ----------
    * Window Component: Content -> p
    * ------ --------- --------
    */
.window .content {
  p {
    color: rgba(255, 255, 255, 0.85);
    font-weight: 300;
    font-size: 14px;
    line-height: 22px;
    margin: 0;
  }
  * + p {
    margin-top: 12px;
  }
}

.window.minimized {
  overflow: hidden;
  width: var(--minimized-width);
  height: var(--minimized-height);
  transform: translate(var(--minimized-x), var(--minimized-y)) !important;
}

.window.maximized {
  $edge-gap: 10px;
  $top: calc(
    (var(--taskbar-verticalGap) * 1px * 2) + (var(--taskbar-height) * 1px)
  );
  $left: $edge-gap;
  width: calc(100vw - #{$edge-gap * 2});
  height: calc(
    100vh -
      (
        #{$edge-gap * 2} + (calc((var(--taskbar-verticalGap) * 1px * 2) +
                (var(--taskbar-height) * 1px)))
      )
  );
  transform: translateY($top) translateX($left) !important;
  z-index: 999999;
  .content {
    width: 100% !important;
    height: calc(100% - 50px) !important;
    resize: none;
  }
}

.window.user-interacting {
  transition: none !important;
}

/* ------ --------- ----------
    * Taskbar Component 
    * ------ --------- --------
    */
.taskbar {
  position: absolute;
  top: calc(var(--taskbar-verticalGap) * 1px);
  left: calc(var(--taskbar-horizontalGap) * 1px);
  width: calc(100% - (var(--taskbar-horizontalGap) * 1px) * 2);
  height: calc(var(--taskbar-height) * 1px);
  display: flex;
  justify-content: flex-end;
  z-index: $z - 1;
}

/* ------ --------- ----------
    * Taskbar Component: Vue
    * ------ --------- --------
    */
.taskbar .vue {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  padding: 10px;
  background-color: rgb(33, 16, 63);
  box-shadow: var(--primary-shadow);
  border-radius: 50%;
  cursor: pointer;
  transition: box-shadow 0.3s ease;
  svg {
    position: relative;
    top: 3px;
    width: 100%;
    height: 100%;
    transition: transform 0.2s ease;
  }
}

.taskbar .vue:hover {
  svg {
    transform: scale(0.9);
  }
  &:before {
    transform: scaleX(1);
    opacity: 1;
  }
}

.taskbar .vue:before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  z-index: -1;
  border-radius: 50%;
  pointer-events: none;
  transform: scaleX(0);
  background-color: rgb(33, 16, 63);
  transition: transform 0.2s ease, opacity 0.1s ease;
  animation: vue-hover 1.2s linear alternate infinite;
}

$vue-anim-primary-color: rgba(255, 255, 255, 0);
@keyframes vue-hover {
  0% {
    box-shadow: 0 -20px 30px -10px transparentize($vue-anim-primary-color, 0%);
    transform: scaleY(1.1);
  }
  25% {
    box-shadow: 20px 0 30px 0 transparentize($vue-anim-primary-color, 0%);
    transform: scaleX(1.1);
  }
  50% {
    box-shadow: 0 10px 10px 0 transparentize($vue-anim-primary-color, 0%);
    transform: scaleX(0.9);
  }
  75% {
    box-shadow: -20px -10px 10px -10px
      transparentize($vue-anim-primary-color, 0%);
    transform: scale(1.1);
  }
  100% {
    box-shadow: 0 -20px 30px -10px transparentize($vue-anim-primary-color, 0%);
    transform: scaleY(1.1);
  }
}

/* ------ --------- ----------
    * Desktop Component
    * ------ --------- --------
    */
.desktop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: $z - 2;
}

.desktop-item {
  position: fixed;
  user-select: none;
  cursor: pointer;
  width: 90px;
  height: 90px;
  &:hover {
    &:before {
      opacity: 1;
    }
  }
}

.desktop-item .wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ------ --------- ----------
    * Desktop Component: Desktop Item
    * ------ --------- --------
    */
.desktop-item:before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  padding: 10px;
  opacity: 0;
  transform: translate(-50%, -55%);
  background-color: rgba(255, 255, 255, 0.12);
  transition: all 0.3s var(--vueos-transition-fn);
  border-radius: 30px;
  backdrop-filter: blur(10px);
  z-index: -1;
}

.desktop-item .icon {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 6px;
  font-weight: 600;
  font-size: 12px;
  line-height: 1em;
  text-transform: capitalize;
  //border: 1px solid rgba(255, 255, 255, 0.1);
  background: #fff;
  border-radius: 50%;
  min-width: 50px;
  min-height: 50px;
  box-sizing: border-box;
  color: #3aa776;
  box-shadow: var(--primary-shadow);
  //backdrop-filter: blur(10px);
  span {
    display: flex;
    overflow: hidden;
    border-radius: 10px;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
}

.desktop-item .name {
  font-weight: 300;
  color: #fff;
  margin-top: 8px;
  width: 100%;
  text-overflow: ellipsis;
  overflow: hidden;
  text-align: center;
  white-space: nowrap;
  text-shadow: var(--primary-text-shadow);
}

.desktop-item.app {
  .icon {
    background-color: #311b50;
    background-color: transparent;
    color: #fff;
    padding: 0;
    &:before {
      content: "app";
      display: block;
      position: absolute;
      bottom: 2px;
      left: 100%;
      background-color: #41b883;
      padding: 2px 3px;
      border-radius: 6px;
      margin-left: -12px;
    }
  }
}

.desktop-item.active {
  .name {
    overflow: visible;
    word-break: break-all;
    white-space: normal;
  }
}

.desktop-item.new {
  @keyframes newFile {
    0% {
      transform: scale(0);
    }
    100% {
      transform: scale(1);
    }
  }
  .wrapper {
    animation-delay: 0.1s;
    animation: newFile 0.3s var(--vueos-transition-fn);
  }
}

$component-controls-color: #adb5b9;
$component-border-color: rgba(255, 255, 255, 0.1);

[component] {
  .component-actions {
    display: flex;
    align-items: center;
    width: 100%;
    height: 35px;
    border: 1px solid $component-border-color;
    border-radius: calc(var(--window-radius) / 2) calc(var(--window-radius) / 2)
      0 0;
    background: #292535;
    white-space: nowrap;
    overflow: hidden;
    a {
      display: inline-block;
      width: 35px;
      height: 35px;
      vertical-align: top;
      line-height: 38px;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      color: $component-controls-color;
      transition: color 0.3s var(--vueos-transition-fn);
      &:hover {
        color: #ffffff;
        [class^="menu"] {
          background: #ffffff;
        }
      }
    }
    [data-role="bold"] {
      font-weight: bold;
    }
    [data-role="italic"] {
      font-style: italic;
    }
    [data-role="underline"] {
      text-decoration: underline;
    }

    [class^="menu"] {
      position: relative;
      top: 48%;
      display: block;
      width: 65%;
      height: 2px;
      margin: 0 auto;
      background: $component-controls-color;
      transition: background 0.3s var(--vueos-transition-fn);
      &:before {
        @extend [class^="menu"];
        content: "";
        top: -5px;
        width: 80%;
      }
      &:after {
        @extend [class^="menu"];
        content: "";
        top: 3px;
        width: 80%;
      }
    }

    .menu-left {
      &:before,
      &:after {
        margin-right: 4px;
      }
    }
    .menu-right {
      &:before,
      &:after {
        margin-left: 4px;
      }
    }

    .save {
      display: flex !important;
      align-items: center;
      width: auto !important;
      margin-left: auto;
      margin-right: 10px;
      i {
        margin-left: 10px;
        font-size: 10px;
        transform: scale(var(--ggs, 0.7));
      }
    }
  }
}

/* ------ --------- ----------
    * Component: Editor
    * ------ --------- --------
    */
[component="Editor"] {
  margin: 0 -10px;
  height: 100%;

  .component-actions {
    border-bottom: none;
  }

  .editor-content {
    max-width: 100%;
    min-width: 100%;
    min-height: calc(100% - 35px);
    padding: 12px;
    overflow: auto;
    font-family: Helvetica, sans-serif;
    font-size: 12px;
    border: 1px solid $component-border-color;
    border-top: none;
    border-radius: 0 0 var(--window-radius) var(--window-radius);
    background: #332e42;
    outline: none;
    color: #fff;
    font-size: 14px;
    @include scrollbar();
  }

  .app-content {
    height: 100%;
  }
}

button.button {
  position: relative;
  display: flex;
  border: none;
  box-shadow: none;
  background-color: #57f9b0;
  border-radius: 20px;
  flex-direction: column;
  align-items: center;
  color: #060606;
  font-weight: 600;
  font-size: 12px;
  width: 100px;
  height: 30px;
  justify-content: center;
  transition: box-shadow 0.3s var(--vueos-transition-fn),
    transform 0.3s var(--vueos-transition-fn);
  box-shadow: 0 10px 8px -7px rgb(34 125 84 / 0%);
  cursor: pointer;
  cursor: pointer;
  i {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transition: all 0.3s var(--vueos-transition-fn);
    transform: translateY(15px) translateX(100%);
    opacity: 0;
    color: #57f9b0;
    user-select: none;
  }
  &.default {
    background-color: #e0e0e0;
    i {
      color: #e0e0e0;
    }
  }
  &:hover {
    //box-shadow: 0 10px 8px -7px #227d54;
    i {
      transform: translateY(15px) translateX(-50%);
      opacity: 1;
    }
  }
}

.form-element {
  display: flex;
  align-items: center;
  border-radius: 4px;
  width: 100%;
  height: 30px;
}

.form-element:hover {
  input[type="text"] {
    background-color: transparentize(#fff, 0.1);
  }
}

.form-element .label {
  display: flex;
  align-items: center;
  color: #e8e8e8;
  font-size: 12px;
  border: 2px solid #ffffff;
  height: 100%;
  padding-right: 10px;
  padding-top: 5px;
  padding-bottom: 5px;
  padding-left: 10px;
  background: #352256;
  border-radius: 8px 0 0 8px;
}

input[type="text"] {
  background-color: #ffffff;
  font-size: 12px;
  border: none;
  outline: none;
  -webkit-tap-highlight-color: transparent;
  width: 100%;
  height: 100%;
  padding: 0 10px;
  transition: background-color 0.3s var(--vueos-transition-fn);
  border-left: none;
  border-radius: 0 8px 8px 0;
  &:focus {
    background-color: transparentize(#fff, 0.1);
  }
}

/* ------ --------- ----------
    * Component: Save
    * ------ --------- --------
    */
[component="Save"] {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  opacity: 0;
  top: 45px;
  left: 50%;
  width: calc(100% - 20px);
  height: 50px;
  z-index: 999;
  transform: translateX(-50%) translateY(-40px);
  transition: all 0.3s var(--vueos-transition-fn);
  border-radius: 16px;
  padding: 10px;
  padding-bottom: 14px;
  box-sizing: content-box;
  .form {
    display: flex;
    align-items: center;
    width: 100%;
  }
  input {
    border-radius: 0;
  }
  button {
    border-radius: 0 8px 8px 0;
  }
  .close-info {
    position: absolute;
    bottom: 0;
    margin: 0 !important;
    font-size: 12px !important;
    font-style: italic;
    color: rgba(255, 255, 255, 0.6) !important;
  }
  &.shown {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }
}

/* ------ --------- ----------
    * Component: Confirmation
    * ------ --------- --------
    */
[component="Confirmation"] {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  opacity: 0;
  top: 45px;
  left: 50%;
  width: auto;
  z-index: 999;
  transform: translateX(-50%) translateY(-40px);
  transition: all 0.3s var(--vueos-transition-fn);
  border-radius: 16px;
  padding: 10px;
  padding-bottom: 14px;
  box-sizing: content-box;
  background: rgba(255, 255, 255, 0.27);
  color: white;
  text-align: center;
  font-size: 12px;
  line-height: 1.4em;
  .actions {
    display: flex;
    margin-top: 10px;
  }
  .button + .button {
    margin-left: 10px;
  }
  &.shown {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }
}

/* ------ --------- ----------
 * Component: Confirmation
 * ------ --------- --------
 */
[component="Vrush"] {
  height: 100%;
  canvas {
    width: 100%;
    height: 100%;
    border: 1px solid rgba(255, 255, 255, 0.04);
    border-radius: calc(var(--window-radius) / 2);
    margin-top: 10px;
  }
  .component-actions {
    border-radius: calc(var(--window-radius) / 2);
  }
  .info {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: rgb(255, 255, 255, 0.5);
  }
}

.svg-icon-templates {
  display: none;
}
</style>